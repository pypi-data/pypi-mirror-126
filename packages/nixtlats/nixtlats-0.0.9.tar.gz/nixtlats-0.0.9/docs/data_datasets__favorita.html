---

title: Kaggle-Competition-Favorita


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/data_datasets__favorita.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/data_datasets__favorita.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%html</span>
<span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span> <span class="nt">table</span> <span class="p">{</span><span class="k">float</span><span class="p">:</span><span class="kc">left</span><span class="p">}</span> <span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<style> table {float:left} </style>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="check_nans" class="doc_header"><code>check_nans</code><a href="https://github.com/Nixtla/nixtlats/tree/master/nixtlats/data/datasets/favorita.py#L39" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>check_nans</code>(<strong><code>df</code></strong>)</p>
</blockquote>
<p>For data wrangling logs</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Favorita" class="doc_header"><code>class</code> <code>Favorita</code><a href="https://github.com/Nixtla/nixtlats/tree/master/nixtlats/data/datasets/favorita.py#L56" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Favorita</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 480M/480M [00:15&lt;00:00, 31.5MiB/s] 
INFO:nixtla.data.datasets.utils:Successfully downloaded favorita-grocery-sales-forecasting.zip?dl=1, 480014675, bytes.
INFO:nixtla.data.datasets.utils:Decompressing zip file...
INFO:nixtla.data.datasets.utils:Successfully decompressed data/favorita/favorita-grocery-sales-forecasting.zip?dl=1
INFO:__main__:Successfully decompressed ./data/favorita/holidays_events.csv.7z
INFO:__main__:Successfully decompressed ./data/favorita/items.csv.7z
INFO:__main__:Successfully decompressed ./data/favorita/oil.csv.7z
INFO:__main__:Successfully decompressed ./data/favorita/sample_submission.csv.7z
INFO:__main__:Successfully decompressed ./data/favorita/stores.csv.7z
INFO:__main__:Successfully decompressed ./data/favorita/test.csv.7z
INFO:__main__:Successfully decompressed ./data/favorita/train.csv.7z
INFO:__main__:Successfully decompressed ./data/favorita/transactions.csv.7z
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>saved train.csv to train.feather for fast access
S wrangle time 8.49 segs 



dataframe n_rows 174685
            col  dtype  nan_prc
0      item_nbr  int32      0.0
1       traj_id  int64      0.0
2      family_0  uint8      0.0
3      family_1  uint8      0.0
4      family_2  uint8      0.0
..          ...    ...      ...
481  cluster_13  uint8      0.0
482  cluster_14  uint8      0.0
483  cluster_15  uint8      0.0
484  cluster_16  uint8      0.0
485   store_nbr   int8      0.0

[486 rows x 3 columns]




dataframe n_rows 125497040
           col           dtype  nan_prc
0         date  datetime64[ns]      0.0
1    store_nbr            int8      0.0
2     item_nbr           int32      0.0
3   unit_sales         float32      0.0
4  onpromotion         boolean      0.0
5         open           int64      0.0


Filter and Removing returns data 4.39 segs


dataframe n_rows 41518905
           col           dtype  nan_prc
0         date  datetime64[ns]      0.0
1    store_nbr            int8      0.0
2     item_nbr           int32      0.0
3   unit_sales         float32      0.0
4  onpromotion         boolean      0.0
5         open           int64      0.0
6      traj_id           int64      0.0


Resampling


dataframe n_rows 58106641
           col           dtype  nan_prc
0    store_nbr            int8      0.0
1     item_nbr           int32      0.0
2      traj_id           int64      0.0
3  onpromotion         boolean      0.0
4         date  datetime64[ns]      0.0
5   unit_sales         float32      0.0
6         open           int64      0.0
7    log_sales         float32      0.0


Resampling to regular grid 803.1067633628845 segs
Transactions variable 12.72 segs
Oil variables 12.66 segs
Calendar variables 12.76 segs
Holiday variables 106.95 segs


dataframe n_rows 58106641
             col           dtype  nan_prc
0      store_nbr            int8      0.0
1       item_nbr           int32      0.0
2        traj_id           int64      0.0
3    onpromotion         boolean      0.0
4           date  datetime64[ns]      0.0
5     unit_sales         float32      0.0
6           open           int64      0.0
7      log_sales         float32      0.0
8   transactions         float64      0.0
9            oil         float64      0.0
10   day_of_week           int64      0.0
11  day_of_month           int64      0.0
12         month           int64      0.0
13  national_hol          object      0.0
14  regional_hol          object      0.0
15     local_hol          object      0.0


Saving processed file to ./data/favorita/temporal.feather
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>item_nbr</th>
      <th>traj_id</th>
      <th>family_0</th>
      <th>family_1</th>
      <th>family_2</th>
      <th>family_3</th>
      <th>family_4</th>
      <th>family_5</th>
      <th>family_6</th>
      <th>family_7</th>
      <th>...</th>
      <th>cluster_7</th>
      <th>cluster_8</th>
      <th>cluster_9</th>
      <th>cluster_10</th>
      <th>cluster_11</th>
      <th>cluster_12</th>
      <th>cluster_13</th>
      <th>cluster_14</th>
      <th>cluster_15</th>
      <th>cluster_16</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>103665</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>105574</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>105575</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>108079</td>
      <td>3</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>108701</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 485 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>unique_id</th>
      <th>ds</th>
      <th>log_sales</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>2015-01-02</td>
      <td>2.302585</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2015-01-03</td>
      <td>1.386294</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>2015-01-04</td>
      <td>1.098612</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>2015-01-05</td>
      <td>0.693147</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>2015-01-06</td>
      <td>1.098612</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>unique_id</th>
      <th>ds</th>
      <th>onpromotion</th>
      <th>open</th>
      <th>transactions</th>
      <th>oil</th>
      <th>day_of_week</th>
      <th>day_of_month</th>
      <th>month</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>2015-01-02</td>
      <td>False</td>
      <td>1</td>
      <td>3114.0</td>
      <td>52.72</td>
      <td>4</td>
      <td>2</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2015-01-03</td>
      <td>False</td>
      <td>1</td>
      <td>2495.0</td>
      <td>-1.00</td>
      <td>5</td>
      <td>3</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>2015-01-04</td>
      <td>False</td>
      <td>1</td>
      <td>999.0</td>
      <td>-1.00</td>
      <td>6</td>
      <td>4</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>2015-01-05</td>
      <td>False</td>
      <td>1</td>
      <td>981.0</td>
      <td>50.05</td>
      <td>0</td>
      <td>5</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>2015-01-06</td>
      <td>False</td>
      <td>1</td>
      <td>827.0</td>
      <td>47.98</td>
      <td>1</td>
      <td>6</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Kaggle-Competition-Favorita-References">Kaggle-Competition-Favorita References<a class="anchor-link" href="#Kaggle-Competition-Favorita-References"> </a></h1><p>The evaluation metric of the Favorita Kaggle competition was the normalized weighted root mean squared logarithmic error (NWRMSLE).
Perishable items have a score weight of 1.25; otherwise, the weight is 1.0.</p>
<p>{% raw %}
$$ NWRMSLE = \sqrt{\frac{\sum^{n}_{i=1} w_{i}\left(log(\hat{y}_{i}+1)  - log(y_{i}+1)\right)^{2}}{\sum^{n}_{i=1} w_{i}}}$$
{% endraw %}</p>
<table>
<thead><tr>
<th style="text-align:center">Kaggle Competition Forecasting Methods</th>
<th style="text-align:center">16D ahead NWRMSLE</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><a href="https://www.kaggle.com/shixw125/1st-place-lgb-model-public-0-506-private-0-511/comments">LGBM</a> [1]</td>
<td style="text-align:center">0.5091</td>
<td></td>
</tr>
<tr>
<td style="text-align:center"><a href="https://arxiv.org/abs/1803.04037">Seq2Seq WaveNet</a> [2]</td>
<td style="text-align:center">0.5129</td>
<td></td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ol>
<li><a href="https://www.kaggle.com/c/favorita-grocery-sales-forecasting/leaderboard">Corporación Favorita. Corporación favorita grocery sales forecasting. Kaggle Competition Leaderboard, 2018.</a></li>
<li><a href="https://arxiv.org/abs/1803.04037">Glib Kechyn, Lucius Yu, Yangguang Zang, and Svyatoslav Kechyn.  Sales forecasting using wavenet within the framework of the Favorita Kaggle competition. Computing Research Repository, abs/1803.04037, 2018</a>.</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Favorita-Extra-References">Favorita Extra References<a class="anchor-link" href="#Favorita-Extra-References"> </a></h1><p>Given that the test set is unavailable, some papers have chosen a different data partition to work on the dataset. The following table uses the favorita dataset with 90 days for training and predicts 30 days into the future for the logarithm of sales. The evaluation metric used in other papers was the quantile risk for P50 (normalized quantile loss):</p>
<p>{% raw %}
$$ QL-risk = \frac{2 \sum_{y_{t} \in \Omega } \sum^{\tau_{max}}_{\tau=t} q (y_{t+\tau}-\hat{y}^{(q)}_{t+\tau})_{+} + (1-q) (\hat{y}^{(q)}_{t+\tau}-y_{t+\tau})_{+} }{\sum_{y_{t} \in \Omega } \sum^{\tau_{max}}_{\tau=1} | y_{t} | }$$
{% endraw %}</p>
<table>
<thead><tr>
<th style="text-align:center">Forecasting Methods</th>
<th style="text-align:center">30D ahead P50 QL-risk</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><a href="https://arxiv.org/abs/2009.14799">MQTransformer</a> [4]</td>
<td style="text-align:center">0.323</td>
<td></td>
</tr>
<tr>
<td style="text-align:center"><a href="https://arxiv.org/abs/1912.09363">TFT</a> [3]</td>
<td style="text-align:center">0.354</td>
<td></td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ol>
<li><a href="https://arxiv.org/abs/1912.09363">Bryan Lim, Sercan O. Arik, Nicolas Loeff, and Tomas Pfister. Temporal fusion transformers for interpretable multi-horizon time series forecasting. Computing Research Repository, abs/1912.09363, 2020</a>.</li>
<li><a href="https://arxiv.org/abs/2009.14799">Carson Eisenach, Yagna Patel, and Dhruv Madeka. MQtransformer: Multi-horizon forecasts with context dependent and feedback-aware attention. Computing Research Repository, abs/2009.14799, 2020</a>.</li>
</ol>

</div>
</div>
</div>
</div>
 

